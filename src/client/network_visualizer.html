<!DOCTYPE html>
<html>
  <head>
    <title>Transport Network Visualizer</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.4/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.4/leaflet.js"></script>
  </head>
  <body>
    <div id="map" style="width: 1200px; height: 900px">
    </div>
    <script type="text/javascript">
      var otp_config = {
          hostname: "http://localhost:8080",
          restService: "otp_networks/routers",
          routerId: "default"
      };
	  //Those are layers and name of properties in a layer if detail=true
	  var layers = {
		  streetEdges:["name", "osm_id", "speed"],
		  permEdges:["name", "osm_id", "label"]
	  };
	  var current_layer = "permEdges";
      var url = otp_config.hostname + '/' + otp_config.restService + '/' + otp_config.routerId + '/';

      function onEachFeature(feature, layer) {
          if (feature.properties) {
              var prop = feature.properties;
			  var pop = "<p>";
			  var layer_info = layers[current_layer];
			  for (var i=0; i < layer_info.length; i++) {
				  pop += layer_info[i].toUpperCase();
				  pop +=": ";
				  pop += prop[layer_info[i]];
				  pop +="<br />";
			  }
			  pop +="</p>";
              layer.bindPopup(pop);
          }
      }

      function styleSpeed(feature) {
          return {
              color: feature.properties.color
          };
      }


      function updateMap () {
        if (window.map.layers) {
          window.map.layers.forEach(function (layer) {
            window.map.removeLayer(layer);
          });
        }

        window.map.layers = [];

        var bbox = window.map.getBounds();
        var params = {
            n : bbox.getNorth(),
            s : bbox.getSouth(),
            e : bbox.getEast(),
            w : bbox.getWest(),
            detail: false //adds name, OSMID and speed as properties
        };


        // add the street layer
        $.ajax({
          data: params,
          url: url + 'visualize/' + current_layer,
          success: function (data) {
              var layer = null;
              if (params.detail == true) {
                  layer = L.geoJson(data, {onEachFeature: onEachFeature,
                                    style: styleSpeed});
              } else {
                  layer = L.geoJson(data);
              }
              layer.addTo(window.map);
          }
        });
      }

      // initialize Leaflet map
      window.map = L.map('map', {'zoom': 11});
      $.ajax(url, {
          dataType: 'JSON',
          success: function(data) {
              window.map.fitBounds([
                  [data.lowerLeftLatitude, data.lowerLeftLongitude],
                  [data.upperRightLatitude, data.upperRightLongitude]
              ]);
          }
      });

      // bg
      L.tileLayer('//{s}.tiles.mapbox.com/v3/conveyal.hml987j0/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery ï¿½ <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 18
        }).addTo(window.map);

      window.map.on('moveend', updateMap);
      updateMap();
    </script>
  </body>
</html>
